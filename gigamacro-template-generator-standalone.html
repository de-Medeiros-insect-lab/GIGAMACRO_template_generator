<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIGAmacro Template Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
            font-weight: 700;
        }

        .section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .field-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }

        input[type="text"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            font-family: monospace;
            min-height: 120px;
        }

        .row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 15px;
            align-items: start;
            margin-bottom: 15px;
        }

        .position-label {
            font-weight: 600;
            padding-top: 10px;
            color: #667eea;
            min-width: 90px;
        }

        .position-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .position-inputs input {
            width: 100%;
        }

        .preview {
            grid-column: 1 / -1;
            padding: 8px;
            background: #f0f4ff;
            border-radius: 4px;
            font-size: 12px;
            color: #667eea;
            font-family: monospace;
            word-break: break-all;
            margin-top: 5px;
            display: none;
        }

        .preview.visible {
            display: block;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: #48bb78;
        }

        button.secondary:hover {
            background: #38a169;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }

        .success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }

        .info {
            background: #e7f3ff;
            border: 1px solid #2196F3;
            color: #0c5460;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
        }

        .input-labels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 13px;
            color: #555;
        }

        .file-upload-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-name {
            flex: 1;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }

        .file-upload-btn {
            padding: 10px 20px;
            width: auto;
            margin: 0;
        }

        #message {
            display: none;
        }

        #message.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GIGAmacro Template Generator</h1>

        <div id="message"></div>

        <div class="section">
            <div class="field-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="customTemplate" onchange="toggleTemplateMode()" style="width: auto;">
                    Use Custom Base Template
                </label>
            </div>

            <div id="customTemplateUpload" style="display: none;">
                <div class="field-group">
                    <label>Upload Custom Template:</label>
                    <div class="file-upload-container">
                        <div class="file-name" id="customFileName">No file selected</div>
                        <button type="button" class="file-upload-btn" onclick="document.getElementById('customTemplateFile').click()">
                            Browse
                        </button>
                        <input type="file" id="customTemplateFile" accept=".txt,.json" style="display: none;" onchange="loadCustomTemplate()">
                    </div>
                </div>
            </div>

            <div class="field-group">
                <label>Lens:</label>
                <select id="lensTypeSelect" onchange="updateLensValue(); loadTemplate()">
                    <option value="TC16M80">TC16M80 (large telecentric)</option>
                    <option value="NiTMX1">NiTMX1 (Nikon toolmakers 1X)</option>
                    <option value="NiTM3X" selected>NiTM3X (Nikon toolmakers 3X)</option>
                    <option value="NiTMX5">NiTMX5 (Nikon toolmakers 5X)</option>
                </select>
                <input type="text" id="lensTypeInput" style="display: none;" placeholder="Enter lens name" oninput="updateAllPreviews()">
            </div>

            <div class="field-group">
                <label>View:</label>
                <select id="viewTypeSelect" onchange="updateViewValue(); loadTemplate()">
                    <option value="dorsal">Dorsal</option>
                    <option value="lateral">Lateral</option>
                    <option value="ventral">Ventral</option>
                    <option value="labels">Labels</option>
                </select>
                <input type="text" id="viewTypeInput" style="display: none;" placeholder="Enter view name" oninput="updateAllPreviews()">
            </div>

            <div class="field-group">
                <label>Row:</label>
                <select id="rowTypeSelect" onchange="updateRowValue(); loadTemplate()">
                    <option value="1">Row 1</option>
                    <option value="2">Row 2</option>
                    <option value="3">Row 3</option>
                </select>
                <input type="text" id="rowTypeInput" style="display: none;" placeholder="Enter row name" oninput="updateAllPreviews()">
            </div>

            <div class="field-group">
                <label>Created by:</label>
                <input type="text" id="createdBy" placeholder="Enter your name">
            </div>
        </div>

        <div class="section">
            <h3 style="margin-bottom: 10px; color: #333;">Paste from Table</h3>
            <div class="info" id="pasteInfo">
                Paste rows from spreadsheet (FMNHINS# | Taxonomy | Type Material)
            </div>
            <textarea id="pasteData" placeholder="Paste your tab or comma-separated data here..."></textarea>
            <button class="secondary" onclick="parseTable()">Parse and Populate Fields</button>
        </div>

        <div class="section">
            <h3 style="margin-bottom: 15px; color: #333;">Position Data</h3>
            <div class="input-labels">
                <div>FMNHINS#</div>
                <div>Taxonomy</div>
                <div>Type Material</div>
            </div>

            <div id="positionsContainer"></div>
        </div>

        <button onclick="generateTemplate()">Generate Template</button>
    </div>

    <script>
        // Python backend logic translated to JavaScript

        // Initialize positions array (will be resized based on template)
        let positions = [];

        // Store loaded template data
        let templateData = null;

        // Track if using custom template
        let isCustomTemplate = false;

        /**
         * Toggle between library templates and custom template
         */
        function toggleTemplateMode() {
            isCustomTemplate = document.getElementById('customTemplate').checked;

            const customUpload = document.getElementById('customTemplateUpload');
            const lensSelect = document.getElementById('lensTypeSelect');
            const lensInput = document.getElementById('lensTypeInput');
            const viewSelect = document.getElementById('viewTypeSelect');
            const viewInput = document.getElementById('viewTypeInput');
            const rowSelect = document.getElementById('rowTypeSelect');
            const rowInput = document.getElementById('rowTypeInput');

            if (isCustomTemplate) {
                // Show custom upload, hide selects, show inputs
                customUpload.style.display = 'block';
                lensSelect.style.display = 'none';
                lensInput.style.display = 'block';
                lensInput.value = lensSelect.value;
                viewSelect.style.display = 'none';
                viewInput.style.display = 'block';
                viewInput.value = viewSelect.value;
                rowSelect.style.display = 'none';
                rowInput.style.display = 'block';
                rowInput.value = rowSelect.value;

                // Clear library template
                templateData = null;
                positions = [];
                renderPositions();
            } else {
                // Hide custom upload, show selects, hide inputs
                customUpload.style.display = 'none';
                lensSelect.style.display = 'block';
                lensInput.style.display = 'none';
                viewSelect.style.display = 'block';
                viewInput.style.display = 'none';
                rowSelect.style.display = 'block';
                rowInput.style.display = 'none';

                // Load library template
                loadTemplate();
            }
        }

        /**
         * Update lens value from select to input
         */
        function updateLensValue() {
            const lensInput = document.getElementById('lensTypeInput');
            const lensSelect = document.getElementById('lensTypeSelect');
            lensInput.value = lensSelect.value;
        }

        /**
         * Update view value from select to input
         */
        function updateViewValue() {
            const viewInput = document.getElementById('viewTypeInput');
            const viewSelect = document.getElementById('viewTypeSelect');
            viewInput.value = viewSelect.value;
        }

        /**
         * Update row value from select to input
         */
        function updateRowValue() {
            const rowInput = document.getElementById('rowTypeInput');
            const rowSelect = document.getElementById('rowTypeSelect');
            rowInput.value = rowSelect.value;
        }

        /**
         * Get current lens value (from select or input)
         */
        function getLensType() {
            return isCustomTemplate
                ? document.getElementById('lensTypeInput').value
                : document.getElementById('lensTypeSelect').value;
        }

        /**
         * Get current view value (from select or input)
         */
        function getViewType() {
            return isCustomTemplate
                ? document.getElementById('viewTypeInput').value
                : document.getElementById('viewTypeSelect').value;
        }

        /**
         * Get current row value (from select or input)
         */
        function getRowType() {
            return isCustomTemplate
                ? document.getElementById('rowTypeInput').value
                : document.getElementById('rowTypeSelect').value;
        }

        /**
         * Load custom template from uploaded file
         */
        async function loadCustomTemplate() {
            const fileInput = document.getElementById('customTemplateFile');
            const fileNameDisplay = document.getElementById('customFileName');

            if (fileInput.files.length === 0) {
                return;
            }

            const file = fileInput.files[0];
            fileNameDisplay.textContent = file.name;

            try {
                const content = await file.text();
                const lines = content.trim().split('\n');

                // Parse JSON lines
                templateData = lines.map(line => JSON.parse(line));

                // Initialize positions array based on template size
                positions = Array(templateData.length).fill().map(() => ({
                    fmnhins: '',
                    taxonomy: '',
                    type_material: ''
                }));

                // Render the position inputs
                renderPositions();

                // Update paste info
                const pasteInfo = document.getElementById('pasteInfo');
                if (pasteInfo) {
                    pasteInfo.textContent = `Paste ${templateData.length} rows from spreadsheet (FMNHINS# | Taxonomy | Type Material)`;
                }

                showMessage('success', `Loaded custom template with ${templateData.length} positions.`);
            } catch (error) {
                showMessage('error', `Error loading custom template: ${error.message}`);
                templateData = null;
                positions = [];
                renderPositions();
            }
        }

        /**
         * Load template from file based on current selections
         */
        async function loadTemplate() {
            // Don't load if using custom template
            if (isCustomTemplate) {
                return;
            }

            const lensType = getLensType();
            const viewType = getViewType();
            const rowType = getRowType();

            // Build template filename based on selections
            const templateFilename = `base_templates/${lensType}_row${rowType}_${viewType}_TEMPLATE.txt`;

            try {
                const response = await fetch(templateFilename);

                if (!response.ok) {
                    showMessage('error', `Template not found: ${templateFilename}. This combination of lens, view, and row is not available.`);
                    templateData = null;
                    positions = [];
                    renderPositions();
                    return;
                }

                const content = await response.text();
                const lines = content.trim().split('\n');

                // Parse JSON lines
                templateData = lines.map(line => JSON.parse(line));

                // Initialize positions array based on template size
                positions = Array(templateData.length).fill().map(() => ({
                    fmnhins: '',
                    taxonomy: '',
                    type_material: ''
                }));

                // Render the position inputs
                renderPositions();

                // Update paste info
                const pasteInfo = document.getElementById('pasteInfo');
                if (pasteInfo) {
                    pasteInfo.textContent = `Paste ${templateData.length} rows from spreadsheet (FMNHINS# | Taxonomy | Type Material)`;
                }

                showMessage('success', `Loaded template with ${templateData.length} positions.`);
            } catch (error) {
                // Check if it's a CORS/network error
                if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                    showMessage('error', `Cannot load templates when opening HTML file directly. Please either: (1) Run a local web server, or (2) Use "File > Open" in your browser and allow local file access. Template needed: ${templateFilename}`);
                } else if (error.name === 'NetworkError' || error.message.includes('NetworkError')) {
                    showMessage('error', `Cannot load templates from file:// protocol. Please open this file via a web server (e.g., python3 -m http.server) or check browser settings for local file access.`);
                } else {
                    showMessage('error', `Error loading template: ${error.message}. Template file: ${templateFilename}`);
                }
                templateData = null;
                positions = [];
                renderPositions();
            }
        }

        /**
         * Python function: sanitize_text()
         * Replace spaces with underscores and check for special characters
         */
        function sanitizeText(text) {
            const hasSpecialChars = /[^a-zA-Z0-9 _]/.test(text);
            if (hasSpecialChars) {
                showMessage('warning', 'Special characters detected. Only alphanumeric characters and spaces are permitted.');
            }
            return text.replace(/ /g, '_');
        }

        /**
         * Python function: parse_table()
         * Parse pasted table data and populate the entry fields
         */
        function parseTable() {
            const pastedData = document.getElementById('pasteData').value;

            if (!pastedData.trim()) {
                showMessage('warning', 'Please paste data into the text box first.');
                return;
            }

            if (!templateData || positions.length === 0) {
                showMessage('warning', 'Please wait for template to load first.');
                return;
            }

            const lines = pastedData.trim().split('\n');

            // Clear existing entries
            positions = positions.map(() => ({ fmnhins: '', taxonomy: '', type_material: '' }));

            // Parse and populate each line
            lines.forEach((line, i) => {
                if (i >= positions.length) return; // Only process up to available positions

                // Try tab-separated first, then comma-separated
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t');
                } else {
                    parts = line.split(',');
                }

                // Remove leading/trailing whitespace from each part
                parts = parts.map(p => p.trim());

                // Populate fields based on available data
                if (parts.length > 0 && parts[0]) {
                    positions[i].fmnhins = parts[0];
                }
                if (parts.length > 1 && parts[1]) {
                    positions[i].taxonomy = parts[1];
                }
                if (parts.length > 2 && parts[2]) {
                    positions[i].type_material = parts[2];
                }
            });

            // Render updated positions
            renderPositions();

            // Clear the paste box after parsing
            document.getElementById('pasteData').value = '';

            showMessage('success', `Populated ${Math.min(lines.length, positions.length)} positions from pasted data.`);
        }

        /**
         * Python function: generate_template()
         * Generate template with updated fields
         */
        async function generateTemplate() {
            const viewType = getViewType();
            const createdBy = document.getElementById('createdBy').value;
            const lensType = getLensType();

            if (!templateData || templateData.length === 0) {
                showMessage('warning', 'Please wait for template to load first.');
                return;
            }

            if (!createdBy.trim()) {
                showMessage('warning', 'Please enter your name in the "Created by" field.');
                return;
            }

            try {
                // Create a deep copy of template data to avoid modifying the original
                const outputData = JSON.parse(JSON.stringify(templateData));

                // Sanitize created_by and get current date
                const createdBySanitized = sanitizeText(createdBy);
                const currentDate = getCurrentDate(); // Format like "12Nov2024"

                // Update fields for each position in the template data
                for (let i = 0; i < outputData.length; i++) {
                    const position = positions[i];
                    const positionEntry = outputData[i];

                    // Sanitize text to remove special characters for final output
                    const fmnhins = sanitizeText(position.fmnhins);
                    const taxonomy = sanitizeText(position.taxonomy);
                    const typeMaterial = sanitizeText(position.type_material);

                    // Build project name parts and filter out empty strings to avoid double underscores
                    const nameParts = [
                        fmnhins,
                        taxonomy,
                        typeMaterial,
                        'h',
                        viewType,
                        lensType,
                        'GMF',
                        `pos_${i + 1}`
                    ].filter(part => part !== '');

                    // Construct the project name and data directory
                    const projectName = nameParts.join('_');
                    const dataDirectory = `${projectName}_`;

                    // Update fields in the template
                    positionEntry.project_name = projectName;
                    positionEntry.project_data_directory = dataDirectory;
                    positionEntry.project_author = createdBySanitized;
                    positionEntry.project_date = currentDate;
                }

                // Convert back to newline-delimited JSON
                const output = outputData.map(entry => JSON.stringify(entry)).join('\n');

                // Download the file
                downloadFile(output, 'gigamacro_template.txt', 'text/plain');

                showMessage('success', 'Template saved successfully!');

            } catch (error) {
                showMessage('error', `Error generating template: ${error.message}`);
            }
        }

        /**
         * Get current date in format "12Nov2024"
         */
        function getCurrentDate() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            return `${day}${month}${year}`;
        }

        /**
         * Download file to user's computer
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // UI Helper Functions

        /**
         * Render all position inputs
         */
        function renderPositions() {
            const container = document.getElementById('positionsContainer');
            container.innerHTML = '';

            if (positions.length === 0) {
                container.innerHTML = '<div class="info">Select lens, view, and row to load template.</div>';
                return;
            }

            for (let i = 0; i < positions.length; i++) {
                const row = document.createElement('div');

                const rowContent = `
                    <div class="row">
                        <div class="position-label">Position ${i + 1}:</div>
                        <div class="position-inputs">
                            <input type="text"
                                   id="fmnhins_${i}"
                                   placeholder="FMNHINS#"
                                   value="${positions[i].fmnhins}"
                                   oninput="updatePosition(${i}, 'fmnhins', this.value)">
                            <input type="text"
                                   id="taxonomy_${i}"
                                   placeholder="Taxonomy"
                                   value="${positions[i].taxonomy}"
                                   oninput="updatePosition(${i}, 'taxonomy', this.value)">
                            <input type="text"
                                   id="type_material_${i}"
                                   placeholder="Type Material"
                                   value="${positions[i].type_material}"
                                   oninput="updatePosition(${i}, 'type_material', this.value)">
                            <div class="preview" id="preview_${i}"></div>
                        </div>
                    </div>
                `;

                row.innerHTML = rowContent;
                container.appendChild(row);
            }

            updateAllPreviews();
        }

        /**
         * Update a position value
         */
        function updatePosition(index, field, value) {
            positions[index][field] = value;
            updatePreview(index);
        }

        /**
         * Python function: update_preview()
         * Update the preview labels with the final names for each position
         */
        function updatePreview(index) {
            const previewEl = document.getElementById(`preview_${index}`);

            if (!previewEl || !positions[index]) {
                return;
            }

            const position = positions[index];
            const viewType = getViewType();
            const lensType = getLensType();

            if (!position.fmnhins && !position.taxonomy && !position.type_material) {
                previewEl.classList.remove('visible');
                return;
            }

            const fmnhins = sanitizeText(position.fmnhins);
            const taxonomy = sanitizeText(position.taxonomy);
            const typeMaterial = sanitizeText(position.type_material);

            // Build preview name parts and filter out empty strings to avoid double underscores
            const nameParts = [
                fmnhins,
                taxonomy,
                typeMaterial,
                'h',
                viewType,
                lensType,
                'GMF',
                `pos_${index + 1}`
            ].filter(part => part !== '');

            // Construct the final name format
            const preview = nameParts.join('_');

            previewEl.textContent = preview;
            previewEl.classList.add('visible');
        }

        /**
         * Update all previews
         */
        function updateAllPreviews() {
            for (let i = 0; i < positions.length; i++) {
                updatePreview(i);
            }
        }

        /**
         * Show message to user
         */
        function showMessage(type, text) {
            const messageEl = document.getElementById('message');
            messageEl.className = `${type} visible`;
            messageEl.textContent = text;

            setTimeout(() => {
                messageEl.classList.remove('visible');
            }, 5000);
        }

        // Initialize on page load
        renderPositions();
        loadTemplate();
    </script>
</body>
</html>
